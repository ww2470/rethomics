---
title: "Loading DAM Data"
author: "Quentin Geissmann"
date: "18 August 2015"
output: html_document
---


Aims
----- 

In this tutorial, we will learn how to load data from [TriKinetics DAM2 monitors](http://www.trikinetics.com/).
Then, we will visually control the quality of the data.
Finally, we will remove dead animals.

Loading data from continuous DAM2 files
----------------------------------------

As usual, we start by loading rethomics.
```{r, eval=FALSE}
library(rethomics)
```

```{r, include=FALSE}
library(rethomics)
```

At this point, you may not have your own DAM file, so we will need to access the one enclosed in the package:

```{r}
sample_file <- system.file('data/DAMfile.txt', package="rethomics")
print(sample_file)
```

Then, we build a **query**.
This is very important to understand exactly what we mean by query in this context.
If you are unsure, I invite you to read through the ["build a query"](./build_a_query.html) tutorial.
In this query, we define:

* the `path` of the input file
* the `start_date` of the experiment
* the `stop_date` of the experiment
* the `region_id`, which refers to the *channel* of the monitor

Then, we add an extract column, where we map these variables to a condition; in our case, 'a' or 'b'.

An important poit here is that the start date also *contains time* (e.g. `2015-07-02_10-00-00` mean the second of july 2015, at 10:00:00). This time defines the *start of the day* (i.e. ZT0).

```{r}
query = data.table(path=sample_file,
                  # note the time (10:00) is added as reference time
                start_date="2015-07-02_10-00-00",
                stop_date="2015-07-07",
                region_id=c(1:32),condition=rep(letters[1:2],each=16))
print(query)
```

We can simply load the raw data like so:
```{r}
dt <- queryDAMFiles(query)
print(dt)
```


Graphical quality control
--------------------------

In this example, I would like to define when animals are moving, and diplay movement over time for each animal.
In other words, I want to add a column called `moving` which is `TRUE` when an animal has crossed a beam within a minute, and `FALSE` otherwise.
In fact, this is exactly what the built-in function `sleepDAMAnnotation` does. Since, `queryDAMFiles` allows us to apply an arbitrary function as we load the data. So we can simply do:

```{r}
dt <- queryDAMFiles(query, FUN=sleepDAMAnnotation)
print(dt)
```

Note the new columns `moving` and `asleep`

```{r, plot=TRUE}
overviewPlot(moving, dt, normalise_var_per_id = TRUE)
```

With this representation, you can spot that animals in `region_id` 21 and 24 seemed to have died before the end ot the experiement

Data curation
----------------------

The aim of the curation is to:

* remove animals that were dead/not present all along.
* remove data *after* death of one animal (but keep the data before).


```{r}
dt_curated <- dt[,curateDeadAnimals(.SD,hours(12)),by=key(dt)]
```
Here, the `hours(12)` means we consider an animal to be dead if and only if it has not crossed a beam for at least 12h (but of course, you can change this).

If we replot the graphical overview:

```{r, plot=TRUE}
overviewPlot(moving, dt_curated, normalise_var_per_id = TRUE)
```

