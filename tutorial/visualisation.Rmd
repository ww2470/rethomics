---
title: "Data visualisation"
author: "Quentin Geissmann"
date: "13 July 2017"
output: html_document
---


Aims
----- 

In this tutorial, we will learn how to:

* Use `ggetho` to prepare a data for a plot and express relationships between variables
* Use `ggplot2` functions to specify and enhence our plots

Prerequisites
--------------

* Familiarity with R and statistical analysis
* Some familiarity with `ggplot2` package (at least having read the [tutorial](http://tutorials.iq.harvard.edu/R/Rgraphics/Rgraphics.html))
* Having dowloaded the [data samples](sample_data.html) in `TUTO_DATA_DIR`


Introduction
----------------------------------------

This is yet another rather abstract/conceptual tutorial which is designed for users who want to take full advantage of the power of `ggplot2` to represent behavioural data. 
When ploting behavioural time series, there are several generalities:

* We have almost always have *time on the x axis*
* We have a *variable of interest* to display
* We often want to *plot a summary of the data* (rather than the raw results). For instance, we want to compute an average of the variable of interest for each window of 60min.
* We may want to *wrap* the time, for instance, on a *circadian day* to understand the trend along the day rather than the long term effect.


```{r, include=FALSE}
library(rethomics)
source("rprint.R")
```


`ggetho`
--------------------------

`ggetho` is **the** plotting fuction in `rethomics`.
In many ways, it behaves very simmilarly to [ggplot()](http://ggplot2.tidyverse.org/reference/ggplot.html), but is does a bit of heavy lifting/preprocessing for us.
The function takes two compulsory arguments:

* `data`, the behavioural `data.table` with a structure as described [here](data_structure.html)
* `mapping`, an aesthetic mapping made by [aes()](http://ggplot2.tidyverse.org/reference/aes.html)

To make this a bit more concrete, let's make three days of **dummy** behavioural data for 20 animals and two conditions.

```{r}
query<- data.table(experiment_id="toy_experiment",
                   region_id=1:20, 
                   condition=c("A","B"))
dt <- toyActivityData(query, duration=days(3), seed=3)

print(dt[1:100])
```

As you can see, in addition to the key (orange columns), we have two variables: `moving`, and `asleep`.
They are both "logical" (i.e. `TRUE` -- internaly 1 --  or `FALSE` -- internally 0). 
The whole concept of the Grammar of Graphics (the GG in ggplot), it to be able to translate a verbal representation in a graph. 
Importantly, `ggetho` (just like `ggplot`) in itself **does not plot any data**, it merely constructs a layout that we can then fill with different **layers**. 
Other tutorials will detail the usage of these layers.

For example, let our variable of interest be `moving` (whether an animal is moving at a given time) and we want moving (as a proportion) on the y axis (and implicitly, t is on the x axis).
We also want different colours (`colour`) for each condition,
then we would start by "translating" this request in a object like this:
```{r, plot=TRUE}
pl1 <- ggetho(dt, aes(y=moving, colour=condition))
pl1
```

Again, **this plot is empty** because no layer was added yet. Though it already know the names and scale of the axis.

Sometimes, the variable of interest will not be on the y axis, instead, we want a colour intensity (z axis) to represent it in some sort of **tile plot**.
When unspecified, the y axis is discrete, and implies one row per individual animals.
```{r, plot=TRUE}
pl2 <- ggetho(dt, aes(z=moving))
pl2
```


Instead of having one row per animal, we may want to show a tile plot where populations of animals are **averaged** per condition, so `condition` is on the y axis, we have one row per condition and we show the variable of interest as a colour value:
```{r, plot=TRUE}
pl3 <- ggetho(dt, aes(y=condition, z=moving))
pl3
```



As an appetiser, let's have a look at two layers we can use `stat_pop_etho()` and `stat_tile_etho()`.

`stat_pop_etho` shows the population average (and error bars), of the variable of interest (`y` axis):

```{r, plot=TRUE}
pl1 + stat_pop_etho() 
```

`stat_tile_etho` shows the variable of interest on a coulour intensity `z` axis):

```{r, plot=TRUE}
pl2 + stat_tile_etho() 
```

Facets
--------------------------------

Since the plot objects generated by `ggetho()` are compatible with `ggplot2`, you can use the same [faceting mechanism](http://ggplot2.tidyverse.org/reference/facet_grid.html).
For example, we can make one subplot (row), for each level of `condition`.

```{r, plot=TRUE}
pl1 <- ggetho(dt, aes(y=moving))
pl1 + stat_pop_etho() + 
  facet_grid( condition ~ .)
```

Coordinates and scales
---------------------

Sometimes, it can be interesting to show circadian data in a circular (polar) coordinate system:

```{r, plot=TRUE}
pl4 <- ggetho(dt, aes(y=asleep, fill=condition), time_wrap = hours(24))
pl4 <- pl4 + stat_pop_etho() + coord_polar() 
pl4
```
 
